rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    function isSignedIn() {
      return request.auth != null;
    }

    // Check if user is the owner (by userId in path or in document)
    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Get budget data (invokes a read - costs money!)
    function getBudgetData(appId, budgetId) {
      return get(/databases/$(database)/documents/artifacts/$(appId)/public/data/budgets/$(budgetId)).data;
    }

    function budgetExists(appId, budgetId) {
      return exists(/databases/$(database)/documents/artifacts/$(appId)/public/data/budgets/$(budgetId));
    }

    // Check permissions based on ALREADY fetched data (saves reads)
    function hasAccessToData(data) {
      return isOwner(data) || isMember(data);
    }

    function isOwner(data) {
      return isSignedIn() && (
        (data.ownerId == request.auth.uid) || 
        (data.ownerId == null && request.auth.uid == data.id) // Legacy support
      );
    }

    function isMember(data) {
      return isSignedIn() && 
             data.get('authorizedUsers', []) is list && 
             request.auth.uid in data.authorizedUsers;
    }

    // New Helper: Check if the user is ONLY removing themselves from the authorizedUsers list
    function isLeaving(data, prevData) {
      let diff = prevData.authorizedUsers.toSet().difference(data.authorizedUsers.toSet());
      let added = data.authorizedUsers.toSet().difference(prevData.authorizedUsers.toSet());
      // No users added AND exactly one user removed AND that user is the requester
      return added.size() == 0 && diff.hasOnly([request.auth.uid]);
    }

    // For access to subcollections where parent document data isn't in resource
    function hasRemoteAccess(appId, budgetId) {
      let data = getBudgetData(appId, budgetId);
      return hasAccessToData(data);
    }

    // --- MATCH RULES ---

    match /artifacts/{appId} {
      
      // 1. USER PROFILES
      match /users/{userId}/metadata/profile {
        allow read: if isSignedIn();
        allow write: if isUser(userId);
      }

      // 2. BUDGET DATA COLLECTIONS (Transactions, Assets, Loans, Categories)
      match /users/{budgetId}/{collectionName}/{docId} {
        allow read, write: if 
          (collectionName in ['transactions', 'assets', 'loans', 'categories']) &&
          (isUser(budgetId) || (budgetExists(appId, budgetId) && hasRemoteAccess(appId, budgetId)));
      }

      // 3. PUBLIC DATA & SHARED BUDGETS
      match /public/data {
        
        match /budgets/{budgetId} {
          
          // READ: Only members or owner
          allow get: if hasAccessToData(resource.data);
          allow list: if hasAccessToData(resource.data);

          // CREATE: Only authorized
          allow create: if isSignedIn() && 
                        request.resource.data.ownerId == request.auth.uid;

          // UPDATE: Owner - all; Member - all except critical fields, UNLESS leaving
          allow update: if isOwner(resource.data) ||
                        (isMember(resource.data) && 
                         (
                           // Standard member update (cannot touch authorizedUsers or ownerId)
                           (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['authorizedUsers', 'ownerId'])) ||
                           // Exception: Leaving the budget (modifying authorizedUsers to remove self)
                           (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['authorizedUsers']) && isLeaving(request.resource.data, resource.data))
                         )
                        );

          // DELETE: Only owner
          allow delete: if isOwner(resource.data);

          // --- SUBCOLLECTIONS ---
          match /{subcollection}/{document=**} {
            allow read, write: if hasRemoteAccess(appId, budgetId);
          }
        }

        // JOIN REQUESTS
        match /budget_requests/{requesterUid} {
          allow create: if isUser(requesterUid);
          allow read, update, delete: if isUser(requesterUid) || 
                                     (resource.data.targetBudgetId != null && 
                                      isOwner(getBudgetData(appId, resource.data.targetBudgetId)));
        }
      }
    }
  }
}