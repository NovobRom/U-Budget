[{"filePath":"C:\\Users\\roman\\Projects\\smart-budget\\src\\__tests__\\unit\\utils\\currency.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[280,283],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[280,283],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1707,1710],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1707,1710],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":81,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2565,2568],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2565,2568],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":97,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3126,3129],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3126,3129],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3620,3623],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3620,3623],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":114,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3728,3731],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3728,3731],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest';\r\n\r\n// We don't import the module statically because we need to reset it between tests\r\n// import { fetchExchangeRate } from '../../../utils/currency';\r\n\r\ndescribe('Currency Utils', () => {\r\n    let fetchExchangeRate: any;\r\n\r\n    beforeEach(async () => {\r\n        vi.resetModules();\r\n        vi.unstubAllGlobals(); // Reset globals like fetch\r\n\r\n        // Mock localStorage\r\n        const localStorageMock = (() => {\r\n            let store: Record<string, string> = {};\r\n            return {\r\n                getItem: vi.fn((key: string) => store[key] || null),\r\n                setItem: vi.fn((key: string, value: string) => {\r\n                    store[key] = value.toString();\r\n                }),\r\n                clear: vi.fn(() => {\r\n                    store = {};\r\n                }),\r\n            };\r\n        })();\r\n\r\n        vi.stubGlobal('localStorage', localStorageMock);\r\n\r\n        // Mock fetch\r\n        vi.stubGlobal('fetch', vi.fn());\r\n\r\n        // Re-import the module\r\n        const module = await import('../../../utils/currency');\r\n        fetchExchangeRate = module.fetchExchangeRate;\r\n    });\r\n\r\n    it('should return 1 if base equals target', async () => {\r\n        const rate = await fetchExchangeRate('USD', 'USD');\r\n        expect(rate).toBe(1);\r\n    });\r\n\r\n    it('should fetch from Monobank and calculate direct rate', async () => {\r\n        const mockMomoData = [\r\n            {\r\n                currencyCodeA: 840, // USD\r\n                currencyCodeB: 980, // UAH\r\n                date: 123456789,\r\n                rateBuy: 40.0,\r\n                rateSell: 41.0,\r\n            },\r\n        ];\r\n\r\n        (fetch as any).mockResolvedValueOnce({\r\n            ok: true,\r\n            json: async () => mockMomoData,\r\n        });\r\n\r\n        const rate = await fetchExchangeRate('USD', 'UAH');\r\n\r\n        expect(fetch).toHaveBeenCalledWith('/monobank/bank/currency');\r\n        // rate should be (40+41)/2 = 40.5\r\n        expect(rate).toBe(40.5);\r\n    });\r\n\r\n    it('should calculate cross rate via UAH', async () => {\r\n        const mockMomoData = [\r\n            {\r\n                currencyCodeA: 840, // USD\r\n                currencyCodeB: 980, // UAH\r\n                rateBuy: 40.0, // USD -> UAH\r\n                rateSell: 40.0,\r\n            },\r\n            {\r\n                currencyCodeA: 978, // EUR\r\n                currencyCodeB: 980, // UAH\r\n                rateBuy: 44.0, // EUR -> UAH\r\n                rateSell: 44.0,\r\n            },\r\n        ];\r\n\r\n        (fetch as any).mockResolvedValueOnce({\r\n            ok: true,\r\n            json: async () => mockMomoData,\r\n        });\r\n\r\n        // USD -> EUR = (USD->UAH) / (EUR->UAH) = 40 / 44 = 0.909...\r\n        const rate = await fetchExchangeRate('USD', 'EUR');\r\n        expect(rate).toBeCloseTo(0.909, 3);\r\n    });\r\n\r\n    it('should use cache if available and fresh', async () => {\r\n        const mockMomoData = [\r\n            { currencyCodeA: 840, currencyCodeB: 980, rateBuy: 40.0, rateSell: 40.0 },\r\n        ];\r\n\r\n        // 1. First call to populate cache\r\n        (fetch as any).mockResolvedValueOnce({\r\n            ok: true,\r\n            json: async () => mockMomoData,\r\n        });\r\n        await fetchExchangeRate('USD', 'UAH');\r\n        expect(fetch).toHaveBeenCalledTimes(1);\r\n\r\n        // 2. Second call should use cache\r\n        await fetchExchangeRate('USD', 'UAH');\r\n        expect(fetch).toHaveBeenCalledTimes(1);\r\n    });\r\n\r\n    it('should fallback to open.er-api if Monobank fails', async () => {\r\n        // First call fails (Monobank)\r\n        (fetch as any).mockResolvedValueOnce({ ok: false });\r\n\r\n        // Second call succeeds (Fallback)\r\n        (fetch as any).mockResolvedValueOnce({\r\n            ok: true,\r\n            json: async () => ({ rates: { EUR: 0.9 } }),\r\n        });\r\n\r\n        const rate = await fetchExchangeRate('USD', 'EUR');\r\n\r\n        // Should verify fallback called\r\n        expect(fetch).toHaveBeenCalledTimes(2);\r\n        expect(fetch).toHaveBeenLastCalledWith('https://open.er-api.com/v6/latest/USD');\r\n        expect(rate).toBe(0.9);\r\n    });\r\n});\r\n","usedDeprecatedRules":[]}]
